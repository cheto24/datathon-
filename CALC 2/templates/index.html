<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Heart Disease Predictor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body class="bg-light">
    <div class="container py-5">
      <div class="card shadow-sm">
        <div class="card-body">
          <h3 class="card-title mb-3">Heart Disease Predictor</h3>
          <p class="text-muted">Enter a patient id (from the dataset) to view essential details and the model's prediction.</p>

          <div class="row g-3">
            <div class="col-md-6">
              <label for="patient_id" class="form-label">Patient id</label>
              <input type="text" class="form-control" id="patient_id" name="patient_id" placeholder="Type id (e.g. 1)">
              <div id="suggestions" class="list-group mt-2" style="max-height:200px;overflow:auto;display:none;"></div>
            </div>
            <div class="col-md-6 align-self-end d-flex gap-2">
              <input type="text" class="form-control" id="id_col" name="id_col" value="id" style="max-width:160px;">
              <button id="go" class="btn btn-primary">Get prediction</button>
              <button id="clear" class="btn btn-outline-secondary">Clear</button>
            </div>
          </div>

          <hr>
          <div id="result-area" style="display:none;"></div>

          <script>
            const sampleIds = {{ sample_ids | tojson }};
            const input = document.getElementById('patient_id');
            const suggestions = document.getElementById('suggestions');
            const resultArea = document.getElementById('result-area');

            function showSuggestions(q) {
              if (!q) { suggestions.style.display='none'; return; }
              const filtered = sampleIds.filter(x => String(x).startsWith(q)).slice(0,50);
              if (!filtered.length) { suggestions.style.display='none'; return; }
              suggestions.innerHTML = filtered.map(x => `<a href='#' class='list-group-item list-group-item-action'>${x}</a>`).join('');
              suggestions.style.display = 'block';
              suggestions.querySelectorAll('a').forEach(a => a.addEventListener('click', e => {
                e.preventDefault(); input.value = a.textContent; suggestions.style.display='none';
              }));
            }

            input.addEventListener('input', e => showSuggestions(e.target.value));
            input.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); doPredict(); } });

            document.getElementById('go').addEventListener('click', e => { e.preventDefault(); doPredict(); });
            document.getElementById('clear').addEventListener('click', e => { e.preventDefault(); input.value=''; resultArea.style.display='none'; suggestions.style.display='none'; });

            async function doPredict() {
              const id = input.value.trim();
              if (!id) return;
              resultArea.innerHTML = `<div class='spinner-border' role='status'><span class='visually-hidden'>Loading...</span></div> Loading...`;
              resultArea.style.display = 'block';
              const id_col = document.getElementById('id_col').value || 'id';
              try {
                const resp = await fetch('/api/predict', {
                  method: 'POST', headers: {'Content-Type':'application/json'},
                  body: JSON.stringify({patient_id: id, id_col})
                });
                const data = await resp.json();
                if (!resp.ok) {
                  resultArea.innerHTML = `<div class='alert alert-danger'>${data.error || 'Error'}</div>`;
                  return;
                }
                // render inline
                let html = `<div class='card'><div class='card-body'>`;
                html += `<h5>Patient ${data.patient_id}</h5>`;
                html += `<p><strong>Prediction:</strong> ${data.prediction} <small class='text-muted'>(raw: ${data.raw})</small></p>`;
                html += `<h6>Essential details</h6><ul class='list-group mb-3'>`;
                for (const [k,v] of Object.entries(data.patient_info)) {
                  html += `<li class='list-group-item'><strong>${k}:</strong> ${v}</li>`;
                }
                html += `</ul><h6>Top features</h6><ol>`;
                for (const r of data.reasons) html += `<li>${r}</li>`;
                html += `</ol></div></div>`;
                resultArea.innerHTML = html;
              } catch (err) {
                resultArea.innerHTML = `<div class='alert alert-danger'>${err.message}</div>`;
              }
            }
          </script>

        </div>
      </div>
      <footer class="mt-3 text-muted small">Model and data are loaded from the project folder.</footer>
    </div>
  </body>
</html>
